!function(){function a(){var a=function(){function a(){}return a.COMMAND_IDS="ids",a.COMMAND_CREATE="create",a.COMMAND_READ="read",a.COMMAND_UPDATE="update",a.COMMAND_DELETE="delete",a.COMMAND_VERSION="version",a.COMMAND_CHANGES="changes",a.CONFIGURATION="streamsConfiguration",a.UPDATE_DELETED=1,a.UPDATE_CREATED=2,a.UPDATE_CHANGED=3,a.DEFAULT_CACHE_UPDATE_INTERVAL=2e3,a}(),b=function(){function b(a){this.configuration=a}return b.prototype.sendRequests=function(a){var b=this;return new Promise(function(c,d){var e=new XMLHttpRequest;e.open("POST","/"+b.configuration.ConnectionPath),e.setRequestHeader("Content-Type","application/json"),e.onreadystatechange=function(){e.readyState===XMLHttpRequest.DONE&&(200!==e.status&&d(e.statusText),c(JSON.parse(e.responseText)))},e.send(JSON.stringify(a))})},b.getReject=function(){return new Promise(function(a,b){b()})},b.prototype.getIds=function(c,d,e,f){return this.sendRequests([{command:a.COMMAND_IDS,nodeId:d,filter:e,options:f,streamId:c}]).then(function(a){return a&&1===a.length&&a[0].ids?a[0].ids:b.getReject()})},b.prototype.readRecord=function(c,d,e){return this.sendRequests([{command:a.COMMAND_READ,id:e,nodeId:d,streamId:c}]).then(function(a){return a&&1===a.length?a[0].record:b.getReject()})},b.prototype.readRecords=function(b,c,d){for(var e=[],f=0;f<d.length;f++)e.push({command:a.COMMAND_READ,id:d[f],nodeId:c,streamId:b});return this.sendRequests(e).then(function(a){for(var b=[],c=0;c<a.length;c++)a[c].record&&b.push(a[c].record);return b})},b.prototype.updateRecords=function(b,c,d,e){for(var f=[],g=0;g<d.length;g++)f.push({command:a.COMMAND_UPDATE,id:d[g].id,nodeId:c,record:d[g],streamId:b,echo:e});return this.sendRequests(f).then(function(a){for(var b=[],c=0;c<a.length;c++)a[c].record&&b.push(a[c].record);return b})},b.prototype.updateRecord=function(c,d,e,f){return this.sendRequests([{command:a.COMMAND_UPDATE,record:e,nodeId:d,echo:f,streamId:c}]).then(function(a){return a&&1===a.length&&a[0].record?a[0].record:b.getReject()})},b.prototype.createRecord=function(c,d,e){return this.sendRequests([{command:a.COMMAND_CREATE,record:e,nodeId:d,streamId:c}]).then(function(a){return a&&1===a.length||a[0].record?a[0].record:b.getReject()})},b.prototype.deleteRecord=function(c,d,e){return this.sendRequests([{command:a.COMMAND_DELETE,id:e,nodeId:d,streamId:c}]).then(function(a){return a&&1===a.length?void 0:b.getReject()})},b.prototype.getVersion=function(c,d){return this.sendRequests([{command:a.COMMAND_VERSION,streamId:c,nodeId:d}]).then(function(a){return a&&1===a.length?a[0].version:b.getReject()})},b.prototype.getOneStreamChanges=function(c,d,e){return this.sendRequests([{command:a.COMMAND_CHANGES,version:e,streamId:c,nodeId:d}]).then(function(a){return a&&1===a.length?a[0].changes:b.getReject()})},b.prototype.getManyStreamsChanges=function(c){for(var d=[],e=0;e<c.length;e++)d.push({command:a.COMMAND_CHANGES,version:c[e].version,streamId:c[e].streamId,nodeId:c[e].nodeId});return this.sendRequests(d).then(function(a){if(!a)return b.getReject();for(var c=[],d=0;d<a.length;d++)c.push({streamId:a[d].streamId,updates:a[d].changes,nodeId:a[d].nodeId});return c})},b}(),c=function(){function b(a){this.dataChannel=a,this.dataChannel.addListener(this),this.innerObject={}}return b.prototype.initialize=function(){var a=this;return this.dataChannel.getIds().then(function(b){return b.length?a.dataChannel.readMany(b).then(function(b){for(var c=0;c<b.length;c++)a.innerObject[b[c].id]=b[c].value}):void 0})},b.prototype.onChange=function(b,c){var d=this;switch(b){case a.UPDATE_CHANGED:case a.UPDATE_CREATED:return this.dataChannel.read(c).then(function(a){d.innerObject[a.id]=a.value});case a.UPDATE_DELETED:delete this.innerObject[c]}return new Promise(function(a){a()})},b.prototype.getKeys=function(){return Object.keys(this.innerObject)},b.prototype.get=function(a){return this.innerObject[a]},b.prototype.set=function(a,b){var c=this.innerObject[a];this.innerObject[a]=b;var d={id:a,value:b};return c?this.dataChannel.update(d,!1).then(function(){}):this.dataChannel.create(d,!1).then(function(){})},b.prototype.remove=function(a){return delete this.innerObject[a],this.dataChannel.remove(a)},b.prototype.getReadOnlyObject=function(){return this.innerObject},b.prototype.destroy=function(){this.dataChannel.removeListener(this),this.dataChannel.close()},b}(),d=function(){function b(a){this.dataChannel=a,this.tree=null,this.recordMap={},this.dataChannel.addListener(this)}return b.prototype.initialize=function(){var a=this;return this.dataChannel.getIds().then(function(b){return a.dataChannel.readMany(b).then(function(b){a.buildTree(b)})})},b.getChildren=function(a){return a.__children},b.setChildren=function(a,b){a.__children=b},b.getParent=function(a){return a.__parent},b.setParent=function(a,b){a.__parent=b},b.removeServiceFields=function(a){for(var b,c={},d=Object.keys(a),e=0;e<d.length;e++)b=d[e],"__parent"!==b&&"__children"!==b&&a.hasOwnProperty(b)&&(c[b]=a[b]);return c},b.prototype.buildTree=function(a){var b={};this.tree=null,this.recordMap={};for(var c=0;c<a.length;c++){var d=a[c];d.parentId?(b.hasOwnProperty(d.parentId)||(b[d.parentId]=[]),b[d.parentId].push(d)):this.tree||(this.tree=d)}this.tree&&this.fillChildren(this.tree,b)},b.prototype.onRecordRemoved=function(a){var c=b.getChildren(a);if(c)for(var d=0;d<c.length;d++)this.onRecordRemoved(c[d]);delete this.recordMap[a.id]},b.prototype.onChange=function(b,c){var d=this;switch(b){case a.UPDATE_CHANGED:return this.dataChannel.read(c).then(function(a){d.updateRecord(a)});case a.UPDATE_DELETED:var e=this.recordMap[c];return this.removeRecord(e),new Promise(function(a){return a()});case a.UPDATE_CREATED:return this.dataChannel.read(c).then(function(a){d.addRecord(a)})}},b.prototype.getRoot=function(){return this.tree},b.prototype.getChildren=function(a){var c=[],d=this.recordMap[a];if(d)for(var e=b.getChildren(d),f=0;f<e.length;f++)c.push(e[f]);return c},b.prototype.getChildIds=function(a){var c=[],d=this.recordMap[a];if(d)for(var e=b.getChildren(d),f=0;f<e.length;f++)c.push(e[f].id);return c},b.prototype.getParentId=function(a){var b=this.recordMap[a];return b?b.parentId:null},b.prototype.removeRecord=function(a){this.onRecordRemoved(a);var c=b.getParent(a);if(c){for(var d=b.getChildren(c),e=0;e<d.length;e++)if(d[e].id===a.id){d.splice(e,1);break}}else this.tree===a&&(this.tree=null)},b.prototype.addRecord=function(a){if(b.setChildren(a,[]),a.parentId){var c=this.recordMap[a.parentId];b.setParent(a,c),c&&(b.getChildren(c).push(a),this.recordMap[a.id]=a)}else this.tree=a,this.recordMap[a.id]=a},b.prototype.fillChildren=function(a,c){var d=c[a.id]||[];b.setChildren(a,d),this.recordMap[a.id]=a;for(var e=0;e<d.length;e++)b.setParent(d[e],a),this.fillChildren(d[e],c)},b.prototype.fillChildrenToRemove=function(a,c){for(var d=b.getChildren(a),e=0;e<d.length;e++)this.fillChildrenToRemove(d[e],c),c.push(d[e].id)},b.prototype.remove=function(a){var b=[],c=this.recordMap[a];this.fillChildrenToRemove(c,b),this.removeRecord(c);for(var d=[],e=0;e<b.length;e++)d.push(this.dataChannel.remove(b[e]));return d.push(this.dataChannel.remove(a)),Promise.all(d).then(function(){})},b.prototype.add=function(a,b){var c=this,d=b;return d.parentId=a,this.dataChannel.create(d,!0).then(function(a){c.addRecord(a)})},b.prototype.get=function(a){return this.recordMap[a]},b.prototype.updateRecord=function(a){var c=this.recordMap[a.id];if(a.parentId===c.parentId)this.recordMap[a.id]=a,b.setParent(a,b.getParent(c)),b.setChildren(a,b.getChildren(c));else{var d=b.getChildren(c);b.setChildren(c,[]),this.removeRecord(c),this.addRecord(a),b.setChildren(a,d)}},b.prototype.update=function(a){var c=this,d=this.recordMap[a.id];return this.dataChannel.update(b.removeServiceFields(d),!1).then(function(){c.updateRecord(a)})},b.prototype.destroy=function(){this.dataChannel.removeListener(this),this.dataChannel.close()},b}(),e=function(){function b(a){this.dataChannel=a,this.dataChannel.addListener(this),this.records=[],this.indexKey="__index"}return b.prototype.getIndex=function(a){return a[this.indexKey]},b.prototype.setIndex=function(a,b){a[this.indexKey]=b},b.prototype.initialize=function(){var a=this;return this.dataChannel.getIds().then(function(b){return a.dataChannel.readMany(b).then(function(b){for(var c=0;c<b.length;c++){var d=b[c],e=a.getIndex(d);a.records[e]=d}})})},b.prototype.count=function(){return this.records.length},b.prototype.createIndex=function(a){var b=this.records.length;return this.setIndex(a,b),this.records[this.records.length]=a,this.dataChannel.update(a,!1).then(function(){})},b.prototype.onChange=function(b,c){var d=this;switch(b){case a.UPDATE_CHANGED:return this.dataChannel.read(c).then(function(a){var b=d.getIndex(a);if(!b)return d.createIndex(a);d.records[b]=a;for(var e=0;e<d.records.length;e++)e!==b&&d.records[e]&&d.records[e].id===c&&(d.records[e]=void 0)});case a.UPDATE_CREATED:return this.dataChannel.read(c).then(function(a){var b=d.getIndex(a);return b?void(d.records[b]=a):d.createIndex(a)});case a.UPDATE_DELETED:for(var e=0;e<this.records.length;e++)if(this.records[e]&&this.records[e].id===c){this.records.splice(e,1);break}return new Promise(function(a){a()})}},b.prototype.push=function(a){return this.setIndex(a,this.records.length),this.records[this.records.length]=a,this.dataChannel.create(a,!1).then(function(b){a.id=b.id})},b.prototype.get=function(a){return this.records[a]},b.prototype.set=function(a,b){var c=this,d=this.records[a];return d?d.id!==b.id?this.dataChannel.remove(d.id).then(function(){return c.setIndex(b,a),c.dataChannel.create(b,!0).then(function(b){c.records[a]=b})}):(this.setIndex(b,a),this.dataChannel.update(b,!1).then(function(){c.records[a]=b})):(this.setIndex(b,a),b.id?this.dataChannel.update(b,!1).then(function(){c.records[a]=b}):this.dataChannel.create(b,!0).then(function(b){c.records[a]=b}))},b.prototype.getReadOnlyArray=function(){return this.records},b.prototype.destroy=function(){this.dataChannel.removeListener(this),this.dataChannel.close()},b.prototype.remove=function(a){var b=this,c=this.records[a];return this.records.splice(a,1),this.dataChannel.remove(c.id).then(function(){for(var c=[],d=a;d<b.records.length;d++)c.push(b.records[d]),b.setIndex(b.records[d],d);return b.dataChannel.updateMany(c,!1).then(function(){})})},b}(),f=function(){function a(a){this.dataChannelStorage=new i(a)}return a.prototype.checkForUpdates=function(){return this.dataChannelStorage.checkForUpdates()},a.prototype.getObject=function(a,b){return this.dataChannelStorage.get(a,b).then(function(a){var b=new c(a);return b.initialize().then(function(){return b})})},a.prototype.getTree=function(a,b){return this.dataChannelStorage.get(a,b).then(function(a){var b=new d(a);return b.initialize().then(function(){return b})})},a.prototype.getArray=function(a,b){return this.dataChannelStorage.get(a,b).then(function(a){var b=new e(a);return b.initialize().then(function(){return b})})},a}(),g=function(a){var c=new b(a);return{structures:new f(c),communication:c}},h=function(){function a(a,b,c,d,e,f){this.storage=a,this.instanceId=b,this.streamId=c,this.nodeId=d,this.communicationService=f,this.version=e,this.listeners=[]}return a.prototype.getStreamId=function(){return this.streamId},a.prototype.getVersion=function(){return this.version},a.prototype.getNodeId=function(){return this.nodeId},a.prototype.onUpdate=function(a,b,c){if(!(c<this.version)){this.version=c;for(var d=0;d<this.listeners.length;d++)this.listeners[d].onChange(a,b)}},a.prototype.initialize=function(){var a=this;return this.version?new Promise(function(a){a()}):this.communicationService.getVersion(this.streamId,this.nodeId).then(function(b){a.version=b})},a.prototype.addListener=function(a){this.listeners.push(a)},a.prototype.removeListener=function(a){for(var b=0;b<this.listeners.length;b++)if(this.listeners[b]===a){this.listeners.splice(b,1);break}},a.prototype.close=function(){this.storage.close(this.instanceId)},a.prototype.getIds=function(a,b){return this.communicationService.getIds(this.streamId,this.nodeId,a,b)},a.prototype.read=function(a){return this.communicationService.readRecord(this.streamId,this.nodeId,a)},a.prototype.readMany=function(a){return this.communicationService.readRecords(this.streamId,this.nodeId,a)},a.prototype.update=function(a,b){return this.communicationService.updateRecord(this.streamId,this.nodeId,a,b)},a.prototype.updateMany=function(a,b){return this.communicationService.updateRecords(this.streamId,this.nodeId,a,b)},a.prototype.create=function(a,b){return this.communicationService.createRecord(this.streamId,this.nodeId,a,b)},a.prototype.remove=function(a){return this.communicationService.deleteRecord(this.streamId,this.nodeId,a)},a}(),i=function(){function a(a){this.communicationService=a,this.tempCounter=0,this.channels={}}return a.prototype.get=function(a,b){this.tempCounter++;for(var c=this.tempCounter.toString(),d=Object.keys(this.channels),e=null,f=0;f<d.length;f++){var g=this.channels[d[f]];if(g.getNodeId()===b&&g.getStreamId()===a){e=g.getVersion();break}}var i=new h(this,c,a,b,e,this.communicationService);return this.channels[c]=i,new Promise(function(a){i.initialize().then(function(){a(i)})})},a.prototype.close=function(a){delete this.channels[a]},a.prototype.checkForUpdates=function(){for(var a=[],b=Object.keys(this.channels),c={},d=0;d<b.length;d++){var e=this.channels[b[d]],f={streamId:e.getStreamId(),version:e.getVersion(),nodeId:e.getNodeId()},g=f.streamId+":"+f.nodeId;c[g]||(c[g]=[],a.push(f)),c[g].push(e)}return this.communicationService.getManyStreamsChanges(a).then(function(a){for(var b=0;b<a.length;b++){var d=a[b],e=d.streamId+":"+d.nodeId,f=c[e];if(f)for(var g=0;g<d.updates.length;g++)for(var h=d.updates[g],i=0;i<f.length;i++)f[i].onUpdate(h.type,h.id,h.version)}})},a}();return g}"function"==typeof define&&define.amd?define([],function(){return a()}):"object"==typeof exports?module.exports=a():window.StreamsClient=a()}();